name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Embed license keys
        working-directory: /home/alfred/repos/saas/saas
        run: |
          echo "$PRIVATE_KEY" > "/home/alfred/repos/saas/saas/saas/api/src/license/private.pem"
          echo "$PUBLIC_KEY" > "/home/alfred/repos/saas/saas/saas/app/license/public.pem"
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}

      - name: Copy .env file
        run: cp /home/alfred/envs/.env.saas.api /home/alfred/repos/saas/saas/saas/api/.env

      - name: Install dependencies
        working-directory: /home/alfred/repos/saas
        run: npm install

      - name: Restart app
        working-directory: /home/alfred/repos/saas
        run: |
          pm2 delete saas-backend || true
          pm2 start src/main.js --name saas-backend --node-args="--env-file=.env" --watch
          pm2 save
