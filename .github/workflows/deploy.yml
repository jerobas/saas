name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Embed license keys
        working-directory: /home/alfred/repos/saas/saas
        run: |
          mkdir -p /home/alfred/repos/saas/saas/saas/api/src/license
          mkdir -p /home/alfred/repos/saas/saas/saas/app/license
          echo "$PRIVATE_KEY" > "/home/alfred/repos/saas/saas/saas/api/src/license/private.pem"
          echo "$PUBLIC_KEY" > "/home/alfred/repos/saas/saas/saas/app/license/public.pem"
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}

      - name: Copy .env file
        run: echo "$ENV_API_SAAS" > /home/alfred/repos/saas/saas/saas/api/.env
        env:
          ENV_API_SAAS: ${{ secrets.ENV_API_SAAS }}

      - name: Install dependencies
        working-directory: /home/alfred/repos/saas/saas/saas/api
        run: npm install

      - name: Restart app
        working-directory: /home/alfred/repos/saas/saas/saas/api
        run: |
          pm2 delete saas-backend || true
          pm2 start src/main.js --name saas-backend --node-args="--env-file=.env" --watch
          pm2 save
